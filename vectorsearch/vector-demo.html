<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Oracle AI Vector Search - Interactive Demo</title>
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(to bottom right,#f8fafc,#e2e8f0);min-height:100vh}
    .header{background:linear-gradient(to right,#0f766e,#115e59);color:#fff;padding:24px;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .header-content{max-width:1280px;margin:0 auto}
    .header-title{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .header-title h1{font-size:30px;font-weight:700}
    .header-subtitle{color:#99f6e4;font-size:14px}
    .container{max-width:1280px;margin:0 auto;padding:24px 24px 0}
    .button-group{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px}
    .btn{padding:8px 16px;border-radius:8px;border:none;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s}
    .btn-teal{background:#0d9488;color:#fff}.btn-teal:hover{background:#0f766e}
    .btn-success{background:#16a34a;color:#fff}
    .btn-gray{background:#e5e7eb;color:#374151}
    .btn-orange{background:#ea580c;color:#fff}
    .btn-danger{background:#ef4444;color:#fff}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;margin-bottom:24px}
    .panel{background:#fff;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,.1);overflow:hidden}
    .panel-header{background:#1f2937;color:#fff;padding:12px 16px;display:flex;align-items:center;gap:8px;font-family:'Courier New',monospace;font-size:14px}
    .panel-header .icon{color:#4ade80}
    .panel-content{padding:16px}
    .sql-box{font-family:'Courier New',monospace;font-size:12px;color:#1f2937;white-space:pre-wrap;background:#f9fafb;padding:16px;border-radius:4px;border:1px solid #e5e7eb;min-height:250px;max-height:250px;overflow-y:auto}
    .data-table-container{margin-top:12px;border-top:2px solid #e5e7eb;padding-top:12px}
    .data-table{width:100%;font-size:11px;border-collapse:collapse}
    .data-table th{background:#f3f4f6;padding:6px 8px;text-align:left;font-weight:600;color:#374151;border:1px solid #e5e7eb}
    .data-table td{padding:6px 8px;border:1px solid #e5e7eb;color:#1f2937}
    .data-table .vector-col{font-family:'Courier New',monospace;font-size:10px;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .data-table tbody tr{cursor:pointer;transition:background .2s}
    .data-table tbody tr:hover{background:#f0fdfa}
    .data-table tbody tr.selected{background:#ccfbf1;border-left:3px solid #0d9488}
    .search-btn{width:100%;padding:12px 16px;background:#f0fdfa;border:2px solid #99f6e4;border-radius:8px;cursor:pointer;transition:all .2s;text-align:left;margin-bottom:8px}
    .search-btn:hover{background:#ccfbf1;border-color:#2dd4bf}
    .search-btn-content{display:flex;justify-content:space-between;align-items:center}
    .search-btn-text{font-size:14px;font-weight:500;color:#111827}
    .search-btn-desc{font-size:12px;color:#6b7280;margin-top:4px}
    .empty-state{padding:48px;text-align:center;color:#9ca3af}
    .result-item{padding:16px;border-bottom:1px solid #e5e7eb;transition:background .2s}
    .result-item:hover{background:#f9fafb}
    .result-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
    .result-left{display:flex;align-items:center;gap:8px}
    .result-badge{width:32px;height:32px;background:#0d9488;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}
    .result-name{font-weight:600;color:#111827}
    .result-category{font-size:12px;color:#6b7280}
    .result-similarity{text-align:right}
    .similarity-score{font-size:18px;font-weight:700;color:#ea580c}
    .similarity-label{font-size:12px;color:#6b7280}
    .result-description{font-size:14px;color:#4b5563;margin-bottom:12px}
    .result-footer{display:flex;justify-content:space-between;align-items:center;font-size:12px}
    .result-price{font-weight:600;color:#111827}
    .vector-viz{display:flex;gap:2px;margin-top:12px}
    .vector-bar{flex:1;height:8px;background:linear-gradient(to top,#5eead4,#0d9488);border-radius:2px}
    .results-banner{padding:12px;background:#f0fdfa;border-bottom:1px solid #99f6e4;font-size:12px;color:#134e4a}

    /* Fullscreen overlay */
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,.72);backdrop-filter:blur(2px);display:none;z-index:1000}
    .overlay.open{display:block}
    .overlay-shell{position:absolute;inset:24px;background:#fff;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,.35);display:grid;grid-template-columns:320px 1fr;overflow:hidden}
    .overlay-header{grid-column:1 / -1;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#0f766e;color:#ecfeff}
    .overlay-title{display:flex;align-items:center;gap:8px;font-weight:700}
    .overlay-close{background:transparent;border:none;font-size:20px;line-height:1;color:#ecfeff;cursor:pointer;padding:6px 10px;border-radius:8px}
    .overlay-close:hover{background:rgba(255,255,255,.12)}
    .overlay-left{border-right:1px solid #e5e7eb;overflow:auto}
    .overlay-left h3{font-size:13px;letter-spacing:.02em;color:#334155;background:#f8fafc;padding:10px 12px;border-bottom:1px solid #e5e7eb}
    .overlay-list{list-style:none}
    .overlay-item{padding:10px 12px;border-bottom:1px solid #f1f5f9;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .overlay-item:hover{background:#f0fdfa}
    .overlay-item.active{background:#ccfbf1;border-left:3px solid #0d9488}
    .overlay-right{padding:16px;display:flex;flex-direction:column;gap:12px}
    #overlayCanvas{width:100%;height:100%;min-height:520px;border:1px solid #e5e7eb;border-radius:8px;background:#f9fafb}
    .overlay-legend{font-size:12px;color:#64748b;text-align:center}
    @media (max-width: 900px){.overlay-shell{grid-template-columns:1fr}}
</style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21 3.582 4-8 4s-8-1.79-8-4"></path>
                </svg>
                <h1>Oracle AI Vector Search</h1>
            </div>
            <p class="header-subtitle">Interactive Demo - Semantic Search with Oracle Database 23ai</p>
        </div>
    </div>

    <!-- Main -->
    <div class="container">
        <div class="button-group">
            <button id="btn1" class="btn btn-teal" onclick="createTable()">1. Create Table</button>
            <button id="btn2" class="btn btn-teal" onclick="createIndex()">2. Create HNSW Index</button>
            <button id="btn3" class="btn btn-teal" onclick="insertData()">3. Insert Data</button>
            <button id="btn4" class="btn btn-gray" onclick="activateSearch()">4. Search Vectors</button>

            <button id="btnToggleMap" class="btn btn-teal" style="display:none" onclick="toggleOverlay()">Toggle Product Map</button>
            <button id="btnReset" class="btn btn-danger" onclick="resetDemo()" title="Clear data and start over">Reset Demo</button>
        </div>

        <div class="grid-3">
            <!-- Column 1 -->
            <div class="panel">
                <div class="panel-header">
                    <span class="icon">‚ñ∂</span><span>SQL Operations</span>
                </div>
                <div class="panel-content">
                    <div id="sqlLog" class="sql-box">-- Welcome to Oracle AI Vector Search Demo
-- Click the buttons above in order (1 ‚Üí 2 ‚Üí 3 ‚Üí 4)
-- Then select a search query to see semantic similarity in action!</div>

                    <div id="dataTableContainer" class="data-table-container" style="display:none;">
                        <div style="font-size:12px;font-weight:600;color:#374151;margin-bottom:8px;">Products Table</div>
                        <div id="dataTable"></div>
                        <!-- Small vector visualization removed on purpose -->
                    </div>
                </div>
            </div>

            <!-- Column 2 -->
            <div class="panel">
                <div class="panel-header"><span style="color:#5eead4;">üîç</span><span>Select Query</span></div>
                <div id="searchPanel" class="empty-state">
                    <p>Click "4. Search Vectors" to begin</p>
                </div>
            </div>

            <!-- Column 3 -->
            <div class="panel">
                <div class="panel-header"><span style="color:#fbbf24;">‚ö°</span><span>Search Results</span></div>
                <div id="searchResults" class="empty-state">
                    <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin:0 auto 16px;opacity:.2">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <p style="font-size:18px;font-weight:500;margin-bottom:8px;">Ready to search!</p>
                    <p style="font-size:14px;">Select a query from the middle panel</p>
                    <p style="font-size:12px;margin-top:16px;">üí° <strong>Key Point:</strong> Products rank by meaning, not keywords</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Overlay -->
    <div id="productOverlay" class="overlay" aria-hidden="true">
        <div class="overlay-shell">
            <div class="overlay-header">
                <div class="overlay-title">üó∫Ô∏è Product Vector Map</div>
                <button class="overlay-close" aria-label="Close product map" onclick="toggleOverlay()">‚úï</button>
            </div>
            <div class="overlay-left">
                <h3>Products</h3>
                <ul id="overlayList" class="overlay-list"></ul>
            </div>
            <div class="overlay-right">
                <canvas id="overlayCanvas" width="1200" height="620"></canvas>
                <div class="overlay-legend">Click a product to toggle highlight ‚Ä¢ Orange = selected</div>
            </div>
        </div>
    </div>

<script>
/* ==============================
   DATA (10 products, fixed layout)
   ============================== */
const products = [
    { id: 1, name: 'Running Shoes', description: 'Comfortable athletic footwear for jogging', price: 89.99, category: 'Footwear',  lx:  0.75, ly:  0.85 },
    { id: 2, name: 'Yoga Mat', description: 'Non-slip exercise mat for yoga and fitness', price: 34.99, category: 'Fitness',    lx:  0.55, ly:  0.80 },
    { id: 3, name: 'Sports Watch', description: 'GPS fitness tracker with heart rate monitor', price: 249.99, category: 'Electronics', lx:  0.85, ly:  0.55 },
    { id: 4, name: 'Protein Powder', description: 'Whey protein supplement for muscle building', price: 45.99, category: 'Nutrition', lx:  0.65, ly:  0.35 },
    { id: 5, name: 'Tennis Racket', description: 'Professional grade tennis racquet', price: 159.99, category: 'Equipment',    lx:  0.90, ly:  0.75 },
    { id: 6, name: 'Basketball', description: 'Official size basketball for indoor and outdoor play', price: 29.99, category: 'Equipment', lx:  0.50, ly:  0.40 },
    { id: 7, name: 'Chef Knife', description: 'Professional kitchen knife for chefs and cooking', price: 79.99, category: 'Kitchen', lx: -0.70, ly:  0.10 },
    { id: 8, name: 'Garden Hose', description: 'Durable outdoor garden hose for watering plants', price: 24.99, category: 'Garden',  lx: -0.85, ly: -0.20 },
    { id: 9, name: 'Ergonomic Desk Chair', description: 'Comfortable office chair with lumbar support', price: 199.99, category: 'Office', lx: -0.40, ly: -0.70 },
    { id:10, name: 'Sketchbook', description: 'Premium drawing sketchbook for artists', price: 14.99, category: 'Art', lx: -0.10, ly: -0.85 }
];

const searchQueries = [
    { key:'run',   text: 'comfortable athletic shoes for running', desc: 'Semantic search for footwear',             qlx:  0.85, qly:  0.80 },
    { key:'fit',   text: 'fitness equipment for home workouts',    desc: 'Find exercise and fitness items',         qlx:  0.60, qly:  0.65 },
    { key:'wear',  text: 'wearable technology for tracking health',desc: 'Smart devices and electronics',           qlx:  0.80, qly:  0.50 },
    { key:'sport', text: 'sports gear for outdoor activities',     desc: 'Equipment for sports and recreation',     qlx:  0.75, qly:  0.45 },
    { key:'supp',  text: 'supplements for building muscle mass',   desc: 'Nutrition and dietary products',          qlx:  0.60, qly:  0.30 },
    { key:'chef',  text: 'kitchen tools for home chefs',           desc: 'Knives and cookware for cooking',         qlx: -0.70, qly:  0.15 },
    { key:'chair', text: 'ergonomic office chair for back support',desc: 'Office furniture for posture',            qlx: -0.45, qly: -0.65 },
    { key:'art',   text: 'art supplies for sketching and drawing', desc: 'Paper and tools for artists',             qlx: -0.15, qly: -0.80 }
];

/* ----- State ----- */
let productVectors = {};
let selectedProducts = new Set();

/* ==============================
   VECTOR MODEL / COSINE / MAPPING
   ============================== */
function makeVectorFromLatent(lx, ly){
    const sportsish = (lx > 0.25 && ly > 0.20);
    const dSports = sportsish ? 0.90 : 0.10;
    const dOther  = sportsish ? 0.10 : 0.90;
    return [
        +lx.toFixed(3),
        +ly.toFixed(3),
        0.12, 0.08, 0.06, 0.05,
        dSports, dOther
    ];
}
function cosineSimilarity(a,b){
    let dot=0, ma=0, mb=0;
    for(let i=0;i<a.length;i++){ dot+=a[i]*b[i]; ma+=a[i]*a[i]; mb+=b[i]*b[i]; }
    if(ma===0||mb===0) return 0;
    return dot/(Math.sqrt(ma)*Math.sqrt(mb));
}
// base readable mapping (kept for general realism)
function readableSimilarity(cos){
    const base = (cos + 1) / 2;       // [0,1]
    const gamma = 0.90;               // slight boost to strong matches
    const stretched = Math.pow(base, gamma);
    const floor = 0.15, ceil = 0.97;  // never 0 or 100
    return Math.max(floor, Math.min(ceil, floor + (ceil - floor) * stretched));
}

/* ==============================
   DRAWING (2D latent projection)
   ============================== */
function latentToScreen(lx, ly){
    const x = (lx + 1) / 2;
    const y = (ly + 1) / 2;
    return { x, y };
}
function drawVectorGraphOn(canvasId){
    // Draws on the FULLSCREEN overlay canvas only (we no longer draw a mini map)
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const width = canvas.width, height = canvas.height;
    const padding = 40, gw = width-2*padding, gh = height-2*padding;

    ctx.clearRect(0,0,width,height);

    // grid
    ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
    for(let i=0;i<=6;i++){
        const gx = padding + (i*gw/6), gy = padding + (i*gh/6);
        ctx.beginPath(); ctx.moveTo(gx,padding); ctx.lineTo(gx,height-padding); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(padding,gy); ctx.lineTo(width-padding,gy); ctx.stroke();
    }
    // axes
    ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(padding,height-padding); ctx.lineTo(width-padding,height-padding); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(padding,padding); ctx.lineTo(padding,height-padding); ctx.stroke();

    // labels
    ctx.fillStyle='#6b7280'; ctx.font='12px sans-serif'; ctx.textAlign='center';
    ctx.fillText('Dimension 1 ‚Üí', width/2, height-10);
    ctx.save(); ctx.translate(15,height/2); ctx.rotate(-Math.PI/2); ctx.fillText('Dimension 2 ‚Üí',0,0); ctx.restore();

    // points
    products.forEach(p=>{
        const {x,y} = latentToScreen(p.lx, p.ly);
        const px = padding + x * (gw);
        const py = height - padding - y * (gh);
        const isSel = selectedProducts.has(p.id);

        ctx.beginPath(); ctx.arc(px,py,isSel?8:6,0,2*Math.PI);
        ctx.fillStyle = isSel ? '#ea580c' : '#0d9488'; ctx.fill();
        ctx.strokeStyle = isSel ? '#fed7aa' : '#ffffff'; ctx.lineWidth = isSel ? 3 : 2; ctx.stroke();

        if(isSel){
            ctx.fillStyle='#1f2937'; ctx.font='bold 12px sans-serif'; ctx.fillText(p.name,px,py-15);
        }
    });
}

/* ==============================
   Overlay helpers
   ============================== */
function toggleProductSelection(productId){
    if(selectedProducts.has(productId)) selectedProducts.delete(productId);
    else selectedProducts.add(productId);

    document.querySelectorAll('.data-table tbody tr').forEach(row=>{
        const rowId = +row.getAttribute('data-product-id');
        row.classList.toggle('selected', selectedProducts.has(rowId));
    });

    document.querySelectorAll('.overlay-item').forEach(li=>{
        const id = +li.getAttribute('data-product-id');
        li.classList.toggle('active', selectedProducts.has(id));
    });

    // Only redraw the FULLSCREEN overlay map
    if(document.getElementById('productOverlay').classList.contains('open')){
        drawVectorGraphOn('overlayCanvas');
    }
}
function buildOverlayList(){
    const ul = document.getElementById('overlayList');
    ul.innerHTML = '';
    products.forEach(p=>{
        const li = document.createElement('li');
        li.className = 'overlay-item';
        li.setAttribute('data-product-id', p.id);
        li.innerHTML = `<span>${p.name}</span><span style="font-size:12px;color:#64748b">$${p.price.toFixed(2)}</span>`;
        li.onclick = ()=>toggleProductSelection(p.id);
        ul.appendChild(li);
    });
}
function toggleOverlay(){
    const overlay = document.getElementById('productOverlay');
    const isOpen = overlay.classList.contains('open');
    overlay.classList.toggle('open', !isOpen);
    overlay.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
    if(!isOpen){
        buildOverlayList();
        drawVectorGraphOn('overlayCanvas');
    }
}

/* ==============================
   Demo actions (SQL steps)
   ============================== */
function createTable(){
    document.getElementById('sqlLog').textContent = `-- Step 1: Create Vector-Enabled Table
CREATE TABLE products (
  product_id NUMBER PRIMARY KEY,
  name VARCHAR2(200),
  description CLOB,
  embedding VECTOR(384),
  price NUMBER(10,2),
  category VARCHAR2(100)
);

-- ‚úì Table created successfully
-- The VECTOR(384) column will store embeddings`;
    markDone('btn1','‚úì 1. Create Table');
    hideDataViz();
    selectedProducts.clear();
}
function createIndex(){
    document.getElementById('sqlLog').textContent = `-- Step 2: Create HNSW Vector Index
CREATE VECTOR INDEX products_hnsw_idx 
ON products(embedding)
ORGANIZATION NEIGHBOR GRAPH
DISTANCE COSINE
WITH TARGET ACCURACY 95;

-- ‚úì Index created successfully
-- HNSW enables fast similarity search at scale`;
    markDone('btn2','‚úì 2. Create HNSW Index');
    hideDataViz();
    selectedProducts.clear();
}
function insertData(){
    products.forEach(p=>{ productVectors[p.id] = makeVectorFromLatent(p.lx, p.ly); });

    const sample = products[0];
    const sampleVector = productVectors[sample.id];
    document.getElementById('sqlLog').textContent = `-- Step 3: Insert Products with Vector Embeddings

-- Example: Insert ${sample.name}
INSERT INTO products VALUES (
  ${sample.id},
  '${sample.name}',
  '${sample.description.replace(/'/g,"''")}',
  TO_VECTOR('[${sampleVector.join(', ')}]', 8, FLOAT32),
  ${sample.price.toFixed(2)},
  '${sample.category}'
);

-- ‚úì ${products.length} products inserted with embeddings`;

    markDone('btn3','‚úì 3. Insert Data');
    document.getElementById('btnToggleMap').style.display='inline-block';

    const container = document.getElementById('dataTableContainer');
    container.style.display='block';

    let html = '<table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Vector (8D)</th></tr></thead><tbody>';
    products.forEach(p=>{
        const v = productVectors[p.id];
        html += `<tr data-product-id="${p.id}">
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td>${p.category}</td>
            <td>${p.price.toFixed(2)}</td>
            <td class="vector-col" title="[${v.join(', ')}]">[${v.map(n=>Number(n).toFixed(2)).join(', ')}]</td>
        </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('dataTable').innerHTML = html;

    // Row click: select only (no small visualization)
    document.querySelectorAll('.data-table tbody tr').forEach(row=>{
        row.addEventListener('click', ()=>{
            const id = +row.getAttribute('data-product-id');
            toggleProductSelection(id);
        });
    });
}

/* ==============================
   SEARCH + targeted % shaping
   ============================== */
function activateSearch(){
    document.getElementById('btn4').className='btn btn-orange';
    let html = '<div class="panel-content"><label style="display:block;font-size:14px;font-weight:600;color:#374151;margin-bottom:8px;">Choose a Search Query</label><p style="font-size:12px;color:#6b7280;margin-bottom:12px;">Click any query to see semantic similarity in action</p>';
    searchQueries.forEach((q,i)=>{
        html += `<button class="search-btn" data-index="${i}">
            <div class="search-btn-content"><span class="search-btn-text">${q.text}</span><span style="color:#0d9488;">‚Üí</span></div>
            <div class="search-btn-desc">${q.desc}</div>
        </button>`;
    });
    html += '</div>';
    document.getElementById('searchPanel').innerHTML = html;

    document.querySelectorAll('.search-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
            e.preventDefault();
            const index = +btn.getAttribute('data-index');
            executeSearch(searchQueries[index]);
        });
    });
}

function executeSearch(q){
    const qVec = makeVectorFromLatent(q.qlx, q.qly);

    document.getElementById('sqlLog').textContent = `-- Vector Similarity Search
SELECT 
  product_id, 
  name, 
  description,
  VECTOR_DISTANCE(embedding, :query_vector, COSINE) AS similarity
FROM products
ORDER BY similarity
FETCH FIRST 5 ROWS ONLY;

-- Query: "${q.text}"
-- Using COSINE distance metric
-- Note: base scores normalized to 15‚Äì97%, then shaped for the demo brief`;

    // Base results (semantic order)
    let base = products.map(p=>{
        const v = productVectors[p.id];
        const cos = cosineSimilarity(qVec, v);
        const sim = readableSimilarity(cos); // 0.15..0.97
        return {...p, similarity: sim, vector: v};
    }).sort((a,b)=>b.similarity-a.similarity).slice(0,5);

    // Shape to match requested behavior
    const results = adjustResults(q.key, base).map(r=>({
        ...r,
        distance: (1 - r.similarity).toFixed(4)
    }));

    let html = '<div class="results-banner"><strong>Results ranked by semantic similarity</strong> ‚Äî closer on the map ‚Üí higher % </div>';
    results.forEach((r,idx)=>{
        html += `<div class="result-item">
            <div class="result-header">
                <div class="result-left">
                    <div class="result-badge">${idx+1}</div>
                    <div><div class="result-name">${r.name}</div><div class="result-category">${r.category}</div></div>
                </div>
                <div class="result-similarity">
                    <div class="similarity-score">${(r.similarity*100).toFixed(1)}%</div>
                    <div class="similarity-label">similarity</div>
                </div>
            </div>
            <p class="result-description">${r.description}</p>
            <div class="result-footer">
                <span style="color:#6b7280;">Distance: <span style="font-family:monospace;font-weight:600;">${r.distance}</span></span>
                <span class="result-price">$${r.price}</span>
            </div>
            <div class="vector-viz">
                ${r.vector.map(v=>`<div class="vector-bar" style="opacity:${Math.max(0.1, Math.min(1, (Math.abs(v)+0.1)))}"></div>`).join('')}
            </div>
        </div>`;
    });
    document.getElementById('searchResults').innerHTML = html;

    // Highlight #1 for the FULLSCREEN overlay only
    selectedProducts = new Set([results[0].id]);
    if(document.getElementById('productOverlay').classList.contains('open')){
        drawVectorGraphOn('overlayCanvas');
    }
}

/* =========================================
   Result shaper ‚Äî enforces your exact brief
   ========================================= */
function adjustResults(key, base){
    const byName = n => base.find(x=>x.name===n);
    const idxByName = n => base.findIndex(x=>x.name===n);
    const ensureInTop5 = (name) => {
        if (idxByName(name) === -1){
            const found = products.find(p=>p.name===name);
            if(found){
                base[base.length-1] = {
                    ...found,
                    similarity: Math.max(0.15, Math.min(0.93, base[base.length-2]?.similarity - 0.02 || 0.60)),
                    vector: productVectors[found.id]
                };
            }
        }
    };
    const setRanksAndScores = (orderedNames, scores) => {
        const used = new Set(), list = [];
        orderedNames.forEach(n=>{
            const item = byName(n);
            if(item){ list.push(item); used.add(item.id); }
        });
        base.forEach(item=>{ if(!used.has(item.id)) list.push(item); });
        const bounded = s => Math.max(0.15, Math.min(0.97, s));
        for(let i=0;i<Math.min(list.length, scores.length); i++){
            list[i] = {...list[i], similarity: bounded(scores[i])};
        }
        for(let i=scores.length;i<list.length;i++){
            const prev = list[i-1].similarity;
            list[i] = {...list[i], similarity: Math.max(0.15, prev - 0.06)};
        }
        return list.slice(0,5);
    };

    switch(key){
        case 'run': {
            ensureInTop5('Running Shoes'); ensureInTop5('Sports Watch');
            const order = ['Running Shoes','Sports Watch'];
            const scores = [0.97, 0.72, 0.62, 0.57, 0.52];
            return setRanksAndScores(order, scores);
        }
        case 'fit': {
            const out = base.slice();
            for(let i=0;i<Math.min(3,out.length);i++){ out[i].similarity = Math.min(out[i].similarity, 0.95); }
            if(out[3]) out[3].similarity = Math.min(out[3].similarity, 0.86);
            if(out[4]) out[4].similarity = Math.min(out[4].similarity, 0.78);
            return out;
        }
        case 'wear': {
            ensureInTop5('Sports Watch');
            const order = ['Sports Watch'];
            const scores = [0.96, 0.78, 0.66, 0.58, 0.51];
            return setRanksAndScores(order, scores);
        }
        case 'sport': {
            const ppIndex = idxByName('Protein Powder');
            let rotated = base.slice();
            if(rotated.length===5){
                const newOrder = [rotated[1], rotated[2], rotated[3], rotated[4], byName('Protein Powder') || rotated[0]];
                if(ppIndex !== -1) newOrder[4] = base[ppIndex];
                rotated = newOrder;
            } else {
                if(ppIndex !== -1){
                    const forced = base.filter(x=>x.name!=='Protein Powder');
                    forced.push(base[ppIndex]);
                    rotated = forced;
                }
            }
            const scores = [0.94, 0.88, 0.82, 0.76, 0.68];
            for(let i=0;i<rotated.length;i++){
                rotated[i] = {...rotated[i], similarity: scores[i] || Math.max(0.15, scores[scores.length-1]-0.06*(i-scores.length+1))};
            }
            return rotated.slice(0,5);
        }
        case 'supp': {
            ensureInTop5('Protein Powder');
            const order = ['Protein Powder'];
            const scores = [0.95, 0.73, 0.60, 0.54, 0.49];
            return setRanksAndScores(order, scores);
        }
        case 'chef': {
            ensureInTop5('Chef Knife');
            const order = ['Chef Knife'];
            const scores = [0.95, 0.74, 0.62, 0.55, 0.50];
            return setRanksAndScores(order, scores);
        }
        case 'chair': {
            ensureInTop5('Ergonomic Desk Chair'); ensureInTop5('Yoga Mat');
            const order = ['Ergonomic Desk Chair','Yoga Mat'];
            const scores = [0.96, 0.72, 0.60, 0.54, 0.49];
            return setRanksAndScores(order, scores);
        }
        default:
            return base;
    }
}

/* ==============================
   Utilities + reset
   ============================== */
function markDone(btnId,label){
    const btn = document.getElementById(btnId);
    btn.innerHTML = label;
    btn.className = 'btn btn-success';
}
function restoreBtn(btnId,label){
    const btn = document.getElementById(btnId);
    btn.innerHTML = label;
    btn.className = 'btn btn-teal';
}
function hideDataViz(){
    document.getElementById('dataTableContainer').style.display='none';
    // mini vector graph removed
}
function resetDemo(){
    productVectors = {};
    selectedProducts.clear();
    restoreBtn('btn1','1. Create Table');
    restoreBtn('btn2','2. Create HNSW Index');
    restoreBtn('btn3','3. Insert Data');
    document.getElementById('btn4').className='btn btn-gray';
    document.getElementById('btn4').innerHTML='4. Search Vectors';
    document.getElementById('btnToggleMap').style.display='none';
    const overlay = document.getElementById('productOverlay');
    overlay.classList.remove('open');
    overlay.setAttribute('aria-hidden','true');

    document.getElementById('sqlLog').textContent = `-- Welcome to Oracle AI Vector Search Demo
-- Click the buttons above in order (1 ‚Üí 2 ‚Üí 3 ‚Üí 4)
-- Then select a search query to see semantic similarity in action!`;
    document.getElementById('dataTableContainer').style.display='none';
    document.getElementById('dataTable').innerHTML='';

    document.getElementById('searchPanel').className='empty-state';
    document.getElementById('searchPanel').innerHTML='<p>Click "4. Search Vectors" to begin</p>';
    document.getElementById('searchResults').className='empty-state';
    document.getElementById('searchResults').innerHTML = `
        <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin:0 auto 16px;opacity:.2">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <p style="font-size:18px;font-weight:500;margin-bottom:8px;">Ready to search!</p>
        <p style="font-size:14px;">Select a query from the middle panel</p>
        <p style="font-size:12px;margin-top:16px;">üí° <strong>Key Point:</strong> Products rank by meaning, not keywords</p>`;
}

window.addEventListener('resize', ()=> {
    // Only redraw the fullscreen overlay map if open
    if(document.getElementById('productOverlay').classList.contains('open')){
        drawVectorGraphOn('overlayCanvas');
    }
});
</script>
</body>
</html>
