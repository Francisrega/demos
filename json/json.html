<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Oracle JSON Relational Duality - Interactive Demo</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      padding: 20px;
      color: #2c3e50;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
      font-size: 2.2em;
    }

    .controls { text-align: center; margin-bottom: 30px; }
    .button-row {
      display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap;
    }
    .label {
      font-weight: bold; margin: 15px 0 10px 0; text-align: center; color: #2c3e50;
    }

    button {
      padding: 12px 20px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer;
      font-size: 14px; transition: all 0.2s ease;
    }
    button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,.2); }
    button:disabled { opacity: .35; cursor: not-allowed; }

    .btn-special { background: linear-gradient(45deg, #8e44ad, #9b59b6); color: #fff; font-size: 16px; padding: 15px 30px; }
    .btn-primary { background: linear-gradient(45deg, #3498db, #2980b9); color: #fff; }
    .btn-success { background: linear-gradient(45deg, #27ae60, #229954); color: #fff; }
    .btn-warning { background: linear-gradient(45deg, #f39c12, #e67e22); color: #fff; }
    .btn-danger  { background: linear-gradient(45deg, #e74c3c, #c0392b); color: #fff; }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    @media (max-width: 1200px) {
      .main-grid { grid-template-columns: 1fr; }
    }

    .panel {
      background: white; border-radius: 15px; padding: 20px; box-shadow: 0 8px 16px rgba(0,0,0,.1); position: relative;
      min-width: 0;
    }
    .panel-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 3px solid #e74c3c;
    }
    .panel-title { font-size: 1.2rem; font-weight: bold; }
    .last-change { margin-left: auto; font-size: 12px; color: #55687b; }

    .code-display {
      background: #1e1e1e; color: #d4d4d4; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Courier New', monospace;
      padding: 15px; border-radius: 10px; min-height: 300px; overflow: auto; white-space: pre; font-size: 13px; line-height: 1.5;
      user-select: text;
    }

    table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
    th { background: #34495e; color: white; padding: 10px; text-align: left; font-size: 14px; }
    td { padding: 10px; border-bottom: 1px solid #ecf0f1; font-size: 14px; }
    tr:hover td { background: #f8f9fa; }

    .toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: #2c3e50; color: white; padding: 12px 24px; border-radius: 25px;
      box-shadow: 0 8px 20px rgba(0,0,0,.3); display: none; z-index: 1000;
    }
    .toast.show { display: block; animation: slideDown .25s ease; }
    @keyframes slideDown { from { transform: translateX(-50%) translateY(-60%);} to { transform: translateX(-50%) translateY(0);} }

    .sql-keyword { color: #569cd6; font-weight: bold; }
    .sql-string  { color: #ce9178; }
    .sql-number  { color: #b5cea8; }

    .inactive { opacity: .4; pointer-events: none; }

    .pulse { animation: pulse 1s ease-in-out 1; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(39,174,96,0.0) }
      50%{ box-shadow: 0 0 0 10px rgba(39,174,96,0.25) }
      100%{ box-shadow: 0 0 0 0 rgba(39,174,96,0.0) }
    }

    @keyframes rowFlash {
      0%   { background: #fff3cd; }
      100% { background: inherit; }
    }
    .row-flash td { animation: rowFlash 1.25s ease-in-out 1; }

    .coach-layer { position: fixed; inset: 0; pointer-events: none; z-index: 3000; }
    .callout {
      position: absolute;
      background: #0f1620;
      color: #e8eef6;
      padding: 8px 12px;
      border-radius: 10px;
      border-left: 3px solid #27ae60;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      font-size: 12px;
      max-width: 260px;
      line-height: 1.35;
    }
    .callout::after {
      content: '';
      position: absolute;
      width: 0; height: 0;
      border: 8px solid transparent;
    }
    .callout.top::after    { bottom: -16px; left: 50%; transform: translateX(-50%); border-top-color: #0f1620; }
    .callout.bottom::after { top: -16px;   left: 50%; transform: translateX(-50%) rotate(180deg); border-top-color: #0f1620; }
    .callout.left::after   { right: -16px; top: 50%; transform: translateY(-50%) rotate(90deg);  border-top-color: #0f1620; }
    .callout.right::after  { left: -16px;  top: 50%; transform: translateY(-50%) rotate(-90deg); border-top-color: #0f1620; }

    .glow {
      box-shadow:
        0 0 0 3px rgba(39, 174, 96, 0.95) inset,
        0 0 0 8px rgba(39, 174, 96, 0.25);
      transition: box-shadow .2s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Oracle JSON Relational Duality ‚Äì Interactive Demo</h1>

    <div class="controls">
      <div class="button-row" id="rowStart" style="margin-bottom: 20px;">
        <button id="populateSQL" class="btn-primary">üìù Populate Orders (SQL)</button>
        <button id="createDuality" class="btn-special">‚ú® Create Duality View</button>
        <button id="resetDemo" class="btn-danger" style="margin-left: 10px;">üîÑ Reset Demo</button>
      </div>

      <div class="label">üìä Relational Operations</div>
      <div class="button-row">
        <button id="updateSQL"   class="btn-warning">‚úèÔ∏è Update Order (SQL)</button>
        <button id="querySQL"    class="btn-danger">üîç Query Orders (SQL)</button>
        <button id="insertSQL"   class="btn-success">‚ûï Insert Order (SQL)</button>
      </div>

      <div class="label">üîÑ Duality View Operations</div>
      <div class="button-row" id="dualityButtons" style="display:none;">
        <button id="insertJSON" class="btn-primary">‚ûï Insert via JSON</button>
        <button id="updateJSON" class="btn-warning">‚úèÔ∏è Update via JSON</button>
        <button id="queryJSON"  class="btn-danger">üîç Query as JSON</button>
      </div>

      <!-- Unified Delete -->
      <div class="label">üóëÔ∏è Unified Delete (affects both views)</div>
      <div class="button-row">
        <button id="deleteOrder" class="btn-danger" disabled>üóëÔ∏è Delete Last Inserted</button>
      </div>
    </div>

    <div class="main-grid">
      <!-- SQL Panel -->
      <div class="panel" id="sqlPanel">
        <div class="panel-header">
          <span class="panel-title">üìù SQL Prompt</span>
          <span class="last-change" id="sqlLast">Last: ‚Äî</span>
        </div>
        <div id="sqlDisplay" class="code-display">-- Ready to execute SQL commands
-- Click buttons above to see SQL operations</div>
      </div>

      <!-- Tables Panel -->
      <div class="panel" id="tablesPanel">
        <div class="panel-header">
          <span class="panel-title">‚äû Relational Tables</span>
        </div>

        <h4>ORDERS</h4>
        <table>
          <thead><tr><th>ORDER_ID</th><th>CUSTOMER_ID</th><th>STATUS</th><th>TOTAL</th></tr></thead>
          <tbody id="ordersTable"><tr><td colspan="4" style="text-align:center;color:#999;">No data yet</td></tr></tbody>
        </table>

        <h4>CUSTOMERS</h4>
        <table>
          <thead><tr><th>CUSTOMER_ID</th><th>NAME</th><th>EMAIL</th><th>TIER</th></tr></thead>
          <tbody id="customersTable"><tr><td colspan="4" style="text-align:center;color:#999;">No data yet</td></tr></tbody>
        </table>

        <h4>ORDER_ITEMS</h4>
        <table>
          <thead><tr><th>ORDER_ID</th><th>PRODUCT_ID</th><th>NAME</th><th>QTY</th><th>PRICE</th></tr></thead>
          <tbody id="itemsTable"><tr><td colspan="5" style="text-align:center;color:#999;">No items</td></tr></tbody>
        </table>
      </div>

      <!-- JSON Panel -->
      <div class="panel inactive" id="jsonPanel">
        <div class="panel-header">
          <span class="panel-title">{} JSON Document View</span>
          <span class="last-change" id="jsonLast">Last: ‚Äî</span>
        </div>
        <div id="jsonDisplay" class="code-display">// Duality View not created yet
// Click "Create Duality View" to enable JSON operations</div>
      </div>
    </div>
  </div>

  <div id="coachLayer" class="coach-layer"></div>
  <div id="toast" class="toast"></div>

  <script>
    // ------------------------ State ------------------------
    let dualityCreated = false;
    let currentOrderId  = null;

    // One source of truth for what to delete next (regardless of SQL or JSON insert)
    let lastInsertedId  = null;  // set by either insert action

    const orders = [];     // [{ id, custId, status, total }]
    const customers = [];  // [{ id, name, email, tier }]
    const items = [];      // [{ orderId, productId, name, qty, price }]

    // --------------------- DOM Helpers ---------------------
    const $ = (id) => document.getElementById(id);

    function showToast(msg, duration = 2200){
      const t = $('toast'); t.textContent = msg; t.className = 'toast show';
      setTimeout(()=> t.className = 'toast', duration);
    }

    function setLast(where, text){
      const el = (where === 'sql') ? $('sqlLast') : $('jsonLast');
      el.textContent = `Last: ${text}`;
    }

    function highlightSQL(sql, lastText){
      const formatted = sql
        .replace(/(CREATE|TABLE|VIEW|INSERT|INTO|VALUES|UPDATE|SET|WHERE|SELECT|FROM|AS|JSON|OBJECT|ARRAY|AND|OR|PRIMARY|KEY|FOREIGN|REFERENCES|VARCHAR2|NUMBER|REPLACE|RELATIONAL|DUALITY|COMMIT|JOIN|ON|GROUP BY|ORDER BY|FETCH FIRST|ONLY|DELETE)/gi,
          '<span class="sql-keyword">$1</span>')
        .replace(/('[^']*')/g, '<span class="sql-string">$1</span>')
        .replace(/(\b\d+\.?\d*\b)/g, '<span class="sql-number">$1</span>');
      $('sqlDisplay').innerHTML = formatted;
      setLast('sql', lastText || '‚Äî');
      pulse($('sqlPanel'));
      coach($('sqlDisplay'), lastText || 'SQL executed', 'bottom');
    }

    function showJSONDoc(objOrMsg, lastText){
      const el = $('jsonDisplay');
      if(typeof objOrMsg === 'string'){ el.textContent = objOrMsg; }
      else { el.textContent = JSON.stringify(objOrMsg, null, 2); }
      setLast('json', lastText || '‚Äî');
      pulse($('jsonPanel'));
      coach($('jsonDisplay'), lastText || 'JSON updated', 'bottom');
    }

    function pulse(el){
      el.classList.add('pulse');
      setTimeout(()=> el.classList.remove('pulse'), 650);
    }

    function coach(targetEl, text, placement='top', ms=2200){
      if(!targetEl) return;
      targetEl.classList.add('glow');
      setTimeout(()=> targetEl.classList.remove('glow'), ms);

      const layer = $('coachLayer');
      const c = document.createElement('div');
      c.className = 'callout ' + placement;
      c.textContent = text;
      layer.appendChild(c);

      const rect = targetEl.getBoundingClientRect();
      const pad = 8; let top = 0, left = 0;
      if(placement === 'top'){ top=rect.top+window.scrollY-c.offsetHeight-pad; left=rect.left+window.scrollX+rect.width/2-c.offsetWidth/2; }
      else if(placement === 'bottom'){ top=rect.bottom+window.scrollY+pad; left=rect.left+window.scrollX+rect.width/2-c.offsetWidth/2; }
      else if(placement === 'left'){ top=rect.top+window.scrollY+rect.height/2-c.offsetHeight/2; left=rect.left+window.scrollX-c.offsetWidth-pad; }
      else { top=rect.top+window.scrollY+rect.height/2-c.offsetHeight/2; left=rect.right+window.scrollX+pad; }

      const maxL = window.scrollX + document.documentElement.clientWidth - c.offsetWidth - 8;
      const minL = window.scrollX + 8;
      left = Math.max(minL, Math.min(left, maxL));
      const maxT = window.scrollY + document.documentElement.clientHeight - c.offsetHeight - 8;
      const minT = window.scrollY + 8;
      top = Math.max(minT, Math.min(top, maxT));

      c.style.top = top + 'px'; c.style.left = left + 'px';
      setTimeout(()=> { c.remove(); }, ms);
    }

    function flashOrderRow(orderId, note='Changed'){
      const row = $(`ordersTable`)?.querySelector(`tr[data-oid="${orderId}"]`);
      if(row){
        row.classList.remove('row-flash'); void row.offsetWidth; row.classList.add('row-flash');
        coach(row, `${note}: ${orderId}`, 'right');
      }
    }

    // Build a JSON document from relational rows (keeps both sides in sync)
    function buildDoc(orderId){
      const o = orders.find(x => x.id === orderId);
      if(!o) return null;
      const c = customers.find(x => x.id === o.custId) || {};
      const its = items.filter(i => i.orderId === orderId);
      return {
        orderId: o.id,
        customer: { id: c.id, name: c.name, email: c.email, tier: c.tier },
        items: its.map(i => ({ productId: i.productId, name: i.name, quantity: i.qty, price: i.price })),
        status: o.status,
        totalAmount: o.total
      };
    }

    function updateTables(){
      $('ordersTable').innerHTML = orders.length
        ? orders.map(o => `<tr data-oid="${o.id}"><td>${o.id}</td><td>${o.custId}</td><td>${o.status}</td><td>$${o.total.toFixed(2)}</td></tr>`).join('')
        : `<tr><td colspan="4" style="text-align:center;color:#999;">No orders</td></tr>`;

      $('customersTable').innerHTML = customers.length
        ? customers.map(c => `<tr><td>${c.id}</td><td>${c.name}</td><td>${c.email}</td><td>${c.tier}</td></tr>`).join('')
        : `<tr><td colspan="4" style="text-align:center;color:#999;">No customers</td></tr>`;

      $('itemsTable').innerHTML = items.length
        ? items.map(i => `<tr><td>${i.orderId}</td><td>${i.productId}</td><td>${i.name}</td><td>${i.qty}</td><td>$${i.price.toFixed(2)}</td></tr>`).join('')
        : `<tr><td colspan="5" style="text-align:center;color:#999;">No items</td></tr>`;
    }

    function syncBothSides(preferredId=null, lastSql='‚Äî', lastJson='‚Äî', flashId=null, flashNote='Changed'){
      updateTables();
      if(dualityCreated){
        const id = preferredId || currentOrderId || (orders[orders.length-1]?.id);
        if(id){
          currentOrderId = id;
          const doc = buildDoc(id);
          if(doc) showJSONDoc(doc, lastJson);
          else showJSONDoc('/* No document available */', lastJson);
        }
      } else { setLast('json', 'Duality not created'); }
      if(flashId){ flashOrderRow(flashId, flashNote); }
    }

    // Unified toggle helpers
    function setInsertsEnabled(enabled){
      $('insertSQL').disabled  = !enabled;
      // JSON insert only enabled if DV exists
      $('insertJSON').disabled = !enabled || !dualityCreated;
      $('deleteOrder').disabled = enabled; // delete is opposite
    }

    // Remove an order and its items
    function deleteOrder(orderId){
      const idx = orders.findIndex(o => o.id === orderId);
      if(idx === -1) return false;
      orders.splice(idx,1);
      for(let i = items.length - 1; i >= 0; i--){
        if(items[i].orderId === orderId) items.splice(i,1);
      }
      if(currentOrderId === orderId){
        currentOrderId = orders[orders.length-1]?.id || null;
      }
      return true;
    }

    // -------------------- Button Handlers --------------------
    $('createDuality').onclick = function(){
      highlightSQL(`-- Creating JSON Relational Duality View (conceptual)
CREATE OR REPLACE JSON RELATIONAL DUALITY VIEW orders_dv AS
  SELECT JSON {
    'orderId'     : o.order_id,
    'customer'    : {
      'id'        : c.customer_id,
      'name'      : c.name,
      'email'     : c.email,
      'tier'      : c.tier
    },
    'items' : [
      SELECT JSON {
        'productId' : oi.product_id,
        'name'      : oi.product_name,
        'quantity'  : oi.quantity,
        'price'     : oi.price
      }
      FROM order_items oi WHERE oi.order_id = o.order_id
    ],
    'status'      : o.status,
    'totalAmount' : o.total_amount
  }
  FROM orders o
  JOIN customers c ON o.customer_id = c.customer_id;`, 'Create Duality View');

      setTimeout(()=>{
        dualityCreated = true;
        this.textContent = '‚úì Duality View Created';
        this.disabled = true;
        $('jsonPanel').classList.remove('inactive');
        $('dualityButtons').style.display = 'flex';
        coach($('jsonPanel'), 'Duality view enabled.\nJSON now mirrors tables.', 'left');
        syncBothSides(null, 'Create Duality View', 'Duality View active');
        // If inserts are currently enabled overall, allow JSON insert too
        if(!$('deleteOrder').disabled){ /* delete active => inserts disabled */ }
        else { $('insertJSON').disabled = false; }
        showToast('‚ú® Duality View Created! JSON operations now available');
      }, 600);
    };

    $('populateSQL').onclick = function(){
      highlightSQL(`-- Creating tables
CREATE TABLE customers ( customer_id VARCHAR2(20) PRIMARY KEY, name VARCHAR2(100), email VARCHAR2(100), tier VARCHAR2(20) );
CREATE TABLE orders    ( order_id VARCHAR2(20) PRIMARY KEY, customer_id VARCHAR2(20), status VARCHAR2(20), total_amount NUMBER(10,2) );
CREATE TABLE order_items ( order_id VARCHAR2(20), product_id VARCHAR2(20), product_name VARCHAR2(100), quantity NUMBER(5), price NUMBER(10,2) );

-- Inserting seed data
INSERT INTO customers VALUES ('CUST-789','Alice Johnson','alice@example.com','GOLD');
INSERT INTO customers VALUES ('CUST-456','Bob Smith','bob@example.com','SILVER');

INSERT INTO orders VALUES ('ORD-2024-001','CUST-789','PROCESSING',107.95);
INSERT INTO orders VALUES ('ORD-2024-002','CUST-456','SHIPPED',85.50);

INSERT INTO order_items VALUES ('ORD-2024-001','PROD-123','Wireless Mouse',2,29.99);
INSERT INTO order_items VALUES ('ORD-2024-001','PROD-456','USB-C Cable',3,15.99);
INSERT INTO order_items VALUES ('ORD-2024-002','PROD-789','Keyboard',1,85.50);

COMMIT;`, 'Populate tables');

      // Reset data and load seeds
      orders.length = 0; customers.length = 0; items.length = 0; lastInsertedId = null;

      customers.push(
        { id:'CUST-789', name:'Alice Johnson', email:'alice@example.com', tier:'GOLD' },
        { id:'CUST-456', name:'Bob Smith',     email:'bob@example.com',   tier:'SILVER' }
      );
      orders.push(
        { id:'ORD-2024-001', custId:'CUST-789', status:'PROCESSING', total:107.95 },
        { id:'ORD-2024-002', custId:'CUST-456', status:'SHIPPED',    total:85.50  }
      );
      items.push(
        { orderId:'ORD-2024-001', productId:'PROD-123', name:'Wireless Mouse', qty:2, price:29.99 },
        { orderId:'ORD-2024-001', productId:'PROD-456', name:'USB-C Cable',    qty:3, price:15.99 },
        { orderId:'ORD-2024-002', productId:'PROD-789', name:'Keyboard',       qty:1, price:85.50 }
      );

      currentOrderId = 'ORD-2024-001';
      syncBothSides(currentOrderId, 'Populate tables', dualityCreated ? 'Synced from relational' : 'Duality not created', 'ORD-2024-001', 'Seeded');
      coach($('tablesPanel'), 'Seed data inserted into 3 tables.', 'top');
      showToast('Tables populated with sample data');

      // After populate: inserts enabled, delete disabled
      setInsertsEnabled(true);
    };

    $('updateSQL').onclick = function(){
      if(!orders.length){ showToast('Please populate tables first'); return; }
      const o = orders[0];
      const next = (o.status === 'PROCESSING') ? 'SHIPPED' : 'PROCESSING';

      highlightSQL(`-- Update order via SQL
UPDATE orders
   SET status = '${next}'
 WHERE order_id = '${o.id}';
COMMIT;`, `Update ${o.id} ‚Üí ${next}`);

      o.status = next;
      currentOrderId = o.id;
      syncBothSides(currentOrderId, `Update ${o.id} ‚Üí ${next}`, `Mirrored ${o.id} ‚Üí ${next}`, o.id, `Status ‚Üí ${next}`);
      showToast(`Order ${o.id} is now ${o.status}`);
    };

    $('querySQL').onclick = function(){
      if(!orders.length){ showToast('Please populate tables first'); return; }
      const resultList = orders
        .filter(o => o.status === 'PROCESSING' || o.status === 'PENDING')
        .map(o => `${o.id} | ${customers.find(c=>c.id===o.custId)?.name || o.custId} | ${o.status} | ${o.total.toFixed(2)}`)
        .join('\n-- ') || '(no rows)';

      highlightSQL(`-- Query with joins
SELECT o.order_id, c.name AS customer_name, o.status, o.total_amount
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
WHERE o.status IN ('PROCESSING','PENDING');

-- Results:
-- ${resultList}`, 'Query (PROCESSING/PENDING)');
      coach($('sqlDisplay'), 'Join query executed.\nShowing first match in JSON (if any).', 'bottom');

      const first = orders.find(o => o.status === 'PROCESSING' || o.status === 'PENDING');
      if(dualityCreated && first){
        currentOrderId = first.id;
        syncBothSides(currentOrderId, 'Query (PROCESSING/PENDING)', `Synced to ${first.id}`, first.id, 'Match');
      } else {
        setLast('json', dualityCreated ? 'No matching document' : 'Duality not created');
      }
      showToast('SQL query executed');
    };

    // ---------- Insert (SQL) -> Unified Delete toggling ----------
    $('insertSQL').onclick = function(){
      const orderId   = 'ORD-2024-003';
      const productId = 'PROD-910';
      const product   = 'Laptop Stand';
      const price     = 45.99;

      if(orders.some(o => o.id === orderId)){
        showToast('Order already exists. Delete it first to re-insert.');
        return;
      }

      highlightSQL(`-- Insert a new order (SQL)
INSERT INTO orders VALUES ('${orderId}','CUST-789','PENDING',${price});
INSERT INTO order_items VALUES ('${orderId}','${productId}','${product}',1,${price});
COMMIT;`, `Insert ${orderId}`);

      orders.push({ id: orderId, custId: 'CUST-789', status: 'PENDING', total: price });
      items.push({ orderId, productId, name: product, qty: 1, price });

      currentOrderId = orderId;
      lastInsertedId = orderId;

      syncBothSides(currentOrderId, `Insert ${orderId}`, `Mirrored ${orderId} (PENDING)`, orderId, 'Inserted');

      // Toggle: disable inserts, enable delete
      setInsertsEnabled(false);
      showToast('Insert complete. Unified delete enabled.');
    };

    // ---------- Insert (JSON) -> Unified Delete toggling ----------
    $('insertJSON').onclick = function(){
      if(!dualityCreated){ return; }

      const orderId   = 'ORD-2024-004';
      const productId = 'PROD-111';
      const product   = 'Monitor';
      const price     = 299.99;

      if(orders.some(o => o.id === orderId)){
        showToast('JSON order already exists. Delete it first to re-insert.');
        return;
      }

      highlightSQL(`-- Insert via Duality View (conceptual single JSON write)
INSERT INTO orders_dv VALUES ('{
  "orderId": "${orderId}",
  "customer": { "id": "CUST-456", "name": "Bob Smith", "email": "bob@example.com", "tier": "SILVER" },
  "items": [ { "productId": "${productId}", "name": "${product}", "quantity": 1, "price": ${price} } ],
  "status": "PENDING",
  "totalAmount": ${price}
}');`, `Insert via JSON ${orderId}`);

      if(!customers.find(c => c.id === 'CUST-456')){
        customers.push({ id:'CUST-456', name:'Bob Smith', email:'bob@example.com', tier:'SILVER' });
      }
      orders.push({ id: orderId, custId: 'CUST-456', status: 'PENDING', total: price });
      items.push({ orderId, productId, name: product, qty: 1, price });

      currentOrderId = orderId;
      lastInsertedId = orderId;

      syncBothSides(currentOrderId, `Insert via JSON ${orderId}`, `Show ${orderId} (PENDING)`, orderId, 'Inserted');
      coach($('jsonPanel'), 'JSON write ‚Üí relational rows created', 'left');

      // Toggle: disable inserts, enable delete
      setInsertsEnabled(false);
      showToast('JSON insert complete. Unified delete enabled.');
    };

    // ---------- Unified Delete ----------
    $('deleteOrder').onclick = function(){
      if(!lastInsertedId){
        showToast('Nothing to delete yet. Insert first.');
        return;
      }

      const sqlShown = dualityCreated
        ? `-- Delete via Duality View (conceptual)\nDELETE FROM orders_dv WHERE "orderId" = '${lastInsertedId}';\nCOMMIT;`
        : `-- Delete via SQL\nDELETE FROM order_items WHERE order_id = '${lastInsertedId}';\nDELETE FROM orders WHERE order_id = '${lastInsertedId}';\nCOMMIT;`;

      highlightSQL(sqlShown, `Delete ${lastInsertedId}`);

      const ok = deleteOrder(lastInsertedId);
      if(ok){
        syncBothSides(currentOrderId, `Delete ${lastInsertedId}`, `Synced after delete`, lastInsertedId, 'Deleted');
        showToast(`Deleted ${lastInsertedId}`);
        lastInsertedId = null;
        // Toggle back: enable inserts, disable delete
        setInsertsEnabled(true);
      } else {
        showToast('Order not found; nothing deleted.');
      }
    };

    $('updateJSON').onclick = function(){
      if(!dualityCreated){ return; }
      if(!orders.length){ showToast('No data to update'); return; }

      const o = orders[orders.length - 1];
      const next = (o.status === 'PENDING' || o.status === 'PROCESSING') ? 'SHIPPED' : 'PROCESSING';

      highlightSQL(`-- Update via Duality View (conceptual)
UPDATE orders_dv
   SET "status" = '${next}'
 WHERE "orderId" = '${o.id}';`, `Update via JSON ${o.id} ‚Üí ${next}`);

      o.status = next;
      currentOrderId = o.id;
      syncBothSides(currentOrderId, `Update via JSON ${o.id} ‚Üí ${next}`, `Show ${o.id} ‚Üí ${next}`, o.id, `Status ‚Üí ${next}`);
      coach($('jsonPanel'), `Status changed ‚Üí ${next}`, 'left');

      showToast(`Duality update ‚Üí ${o.id} is now ${o.status}`);
    };

    // --------------------- Reset Demo ----------------------
    $('resetDemo').onclick = function(){
      dualityCreated = false;
      currentOrderId = null;
      lastInsertedId = null;

      orders.length = 0;
      customers.length = 0;
      items.length = 0;

      $('createDuality').textContent = '‚ú® Create Duality View';
      $('createDuality').disabled = false;
      $('dualityButtons').style.display = 'none';
      $('jsonPanel').classList.add('inactive');

      setInsertsEnabled(true); // enables SQL insert; JSON insert will remain disabled until DV created

      $('sqlDisplay').textContent = `-- Ready to execute SQL commands
-- Click buttons above to see SQL operations`;
      setLast('sql','‚Äî'); setLast('json','‚Äî');
      $('jsonDisplay').textContent = `// Duality View not created yet
// Click "Create Duality View" to enable JSON operations`;

      updateTables();
      $('coachLayer').innerHTML = '';
      showToast('Demo reset! Populate tables or create the Duality View.');
      coach($('rowStart'), 'Start again: Populate ‚Üí Create Duality View', 'bottom');
    };

    // ------------------- Initial Toast ---------------------
    showToast('Welcome! Start with Populate Orders, then Create the Duality View');
    coach($('rowStart'), 'Click here to begin the flow', 'bottom');
  </script>
</body>
</html>
